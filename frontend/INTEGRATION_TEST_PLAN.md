# 前后端集成测试方案

## 📋 测试概述

### 测试目标
验证前后端完整集成，确保所有 API 接口正常工作，数据同步稳定可靠，用户体验流畅。

### 测试范围
- ✅ API 客户端与后端服务通信
- ✅ 用户认证和会话管理
- ✅ 任务管理系统（CRUD 操作）
- ✅ 积分等级系统
- ✅ 实时数据同步（WebSocket）
- ✅ 离线数据缓存和同步
- ✅ 冲突检测和解决
- ✅ 错误处理和恢复

### 测试环境
- **前端**: http://localhost:3000 (Next.js 开发服务器)
- **后端**: http://localhost:8000 (Express 服务器)
- **数据库**: SQLite (Prisma ORM)

## 🧪 测试阶段

### 阶段 1: 基础连接测试 (5-10 分钟)

#### 1.1 服务启动验证
```bash
# 后端服务启动
cd backend && npm run dev

# 前端服务启动
cd frontend && npm run dev
```

**验收标准:**
- [ ] 后端服务在 8000 端口正常启动
- [ ] 前端服务在 3000 端口正常启动
- [ ] 后端健康检查接口返回正常: `GET /health`
- [ ] 前端能访问后端 API 信息: `GET /api`

#### 1.2 基础通信测试
- [ ] API 客户端能正确连接后端
- [ ] CORS 配置正常工作
- [ ] 网络错误处理机制正常

### 阶段 2: API 集成测试 (20-30 分钟)

#### 2.1 任务管理 API 测试
**测试用例:**
```typescript
// 创建任务
POST /api/tasks
{
  "title": "测试任务",
  "description": "集成测试任务",
  "type": "DAILY",
  "starCoins": 10,
  "expReward": 5
}

// 获取任务列表
GET /api/tasks

// 更新任务
PUT /api/tasks/:id
{
  "title": "更新后的任务"
}

// 完成任务
POST /api/tasks/complete
{
  "taskId": "task-id"
}

// 删除任务
DELETE /api/tasks/:id
```

**验收标准:**
- [ ] 所有 CRUD 操作正常
- [ ] 响应格式符合 API 规范
- [ ] 错误处理正确

#### 2.2 积分等级 API 测试
**测试用例:**
```typescript
// 获取用户积分
GET /api/points/user/:userId

// 获取积分交易记录
GET /api/points/transactions/:userId

// 获取等级统计
GET /api/points/stats/:userId

// 兑换奖励
POST /api/points/exchange/:userId
{
  "rewardId": "reward-1",
  "cost": 50
}
```

**验收标准:**
- [ ] 积分计算准确
- [ ] 等级系统正常
- [ ] 交易记录完整

#### 2.3 惩罚系统 API 测试
**测试用例:**
```typescript
// 获取惩罚记录
GET /api/punishments?userId=:userId

// 创建惩罚
POST /api/punishments
{
  "userId": "user-id",
  "ruleId": "rule-1",
  "reason": "测试违规"
}
```

**验收标准:**
- [ ] 惩罚系统逻辑正确
- [ ] 权限控制有效

### 阶段 3: 实时同步测试 (15-20 分钟)

#### 3.1 WebSocket 连接测试
**测试步骤:**
1. 建立多个浏览器标签页
2. 在一个标签页进行数据操作
3. 观察其他标签页是否实时更新

**测试用例:**
- [ ] WebSocket 连接建立正常
- [ ] 多设备同时在线
- [ ] 实时数据推送

#### 3.2 同步事件测试
**事件类型:**
- `TASK_CREATED` - 任务创建
- `TASK_UPDATED` - 任务更新
- `TASK_COMPLETED` - 任务完成
- `POINTS_CHANGED` - 积分变化
- `LEVEL_UP` - 等级提升

**验收标准:**
- [ ] 所有事件类型正常触发
- [ ] 事件数据格式正确
- [ ] UI 实时更新

### 阶段 4: 离线功能测试 (20-30 分钟)

#### 4.1 离线操作测试
**测试步骤:**
1. 断开网络连接
2. 进行各种数据操作
3. 恢复网络连接
4. 检查数据自动同步

**测试用例:**
```typescript
// 离线创建任务
// 离线完成任务
// 离线更新任务
// 离线删除任务
```

**验收标准:**
- [ ] 离线操作正常
- [ ] 乐观更新机制工作
- [ ] 网络恢复后自动同步

#### 4.2 缓存机制测试
**测试用例:**
- [ ] 数据正确缓存到 IndexedDB
- [ ] 缓存数据过期处理
- [ ] 缓存清理机制

#### 4.3 冲突解决测试
**模拟场景:**
1. 在两个设备同时修改同一任务
2. 检测冲突
3. 选择解决策略
4. 验证解决结果

**验收标准:**
- [ ] 冲突检测准确
- [ ] 解决策略有效
- [ ] 数据一致性保持

### 阶段 5: 错误处理和边界测试 (15-20 分钟)

#### 5.1 网络错误测试
**测试场景:**
- [ ] 网络连接中断
- [ ] 服务器无响应
- [ ] API 请求超时
- [ ] HTTP 4xx/5xx 错误

#### 5.2 数据验证测试
**测试用例:**
- [ ] 无效的输入数据
- [ ] 缺少必需字段
- [ ] 数据格式错误
- [ ] 权限不足

#### 5.3 并发操作测试
**测试场景:**
- [ ] 同时多个 API 请求
- [ ] 快速连续操作
- [ ] 大量数据处理

## 📊 测试工具和方法

### 自动化测试工具
```bash
# 安装测试依赖
npm install --save-dev @playwright/test

# 运行 E2E 测试
npx playwright test

# API 测试
npm test -- tests/api/
```

### 测试数据准备
```typescript
// 测试用户数据
const testUser = {
  username: 'test-user',
  displayName: '测试用户',
  role: 'CHILD'
};

// 测试任务数据
const testTask = {
  title: '集成测试任务',
  description: '用于前后端集成测试的任务',
  type: 'DAILY',
  starCoins: 10,
  expReward: 5
};
```

### 手动测试清单
- [ ] 用户登录流程
- [ ] 任务创建、编辑、删除流程
- [ ] 任务完成和积分获取
- [ ] 等级提升和奖励查看
- [ ] 离线操作和网络恢复
- [ ] 多设备数据同步

## 🎯 成功标准

### 功能性标准
- [ ] 所有 API 接口正常工作
- [ ] 数据实时同步准确
- [ ] 离线功能完整可用
- [ ] 冲突解决机制有效

### 性能标准
- [ ] API 响应时间 < 2 秒
- [ ] 实时同步延迟 < 1 秒
- [ ] 离线数据加载 < 500ms

### 用户体验标准
- [ ] 操作流畅无卡顿
- [ ] 错误提示清晰友好
- [ ] 状态反馈及时准确

### 稳定性标准
- [ ] 连续运行 1 小时无崩溃
- [ ] 异常情况能自动恢复
- [ ] 数据完整性得到保证

## 📋 测试报告模板

### 测试结果记录
| 测试项 | 状态 | 问题描述 | 解决方案 |
|--------|------|----------|----------|
| API 连接 | ✅/❌ | | |
| 数据同步 | ✅/❌ | | |
| 离线功能 | ✅/❌ | | |

### 性能指标
- API 平均响应时间: ____ms
- 同步成功率: ____%
- 缓存命中率: ____%

### 发现的问题
1. 问题描述
   - 严重程度: 高/中/低
   - 复现步骤
   - 期望结果
   - 实际结果

2. ...

## 🚀 后续优化计划

1. **性能优化**
   - API 响应时间优化
   - 前端渲染性能提升
   - 缓存策略优化

2. **功能增强**
   - 更多离线功能
   - 冲突解决策略优化
   - 数据同步算法改进

3. **监控和日志**
   - 性能监控
   - 错误日志收集
   - 用户行为分析

---

**测试执行时间预估**: 1.5 - 2 小时
**测试人员**: 前后端开发工程师
**测试环境**: 开发环境
**测试版本**: v1.0.0-alpha